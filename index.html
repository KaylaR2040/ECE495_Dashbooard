<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ECE 495 • Dashboard</title>
  <style>
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 20px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .pill{ padding:6px 10px; border:1px solid #ddd; border-radius:999px; font-size: 12.5px; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); gap: 12px; margin-top: 14px; }
    .card{ border:1px solid #ddd; border-radius: 14px; padding: 12px; }
    .bar{ height: 10px; background:#eee; border-radius:999px; overflow:hidden; margin-top: 10px; }
    .bar > span{ display:block; height:100%; width:0%; background: linear-gradient(90deg, #3b82f6, #22c55e); }
    .muted{ color:#666; font-size: 12.5px; line-height: 1.35; }
    a{ color:#2563eb; text-decoration:none; } a:hover{ text-decoration:underline; }
    pre{ white-space: pre-wrap; word-break: break-word; background:#f7f7f7; padding: 10px; border-radius: 10px; border:1px solid #eee; }
  </style>
</head>
<body>
  <h1>ECE 495 • Progress Dashboard</h1>
  <div class="row">
    <div class="pill">Last refresh: <span id="refresh">—</span></div>
    <div class="pill">Generated: <span id="generatedAt">—</span></div>
    <div class="pill">Root: <a id="rootLink" href="#" target="_blank" rel="noopener">open</a></div>
    <div class="pill">Overall: <b id="overallPct">—</b></div>
  </div>

  <div class="bar" aria-label="overall progress"><span id="overallBar"></span></div>
  <p class="muted">This is a minimal “it works” dashboard. Once this loads correctly, we can swap in the nicer UI.</p>

  <div class="grid" id="folders"></div>

  <h2>Debug (raw JSON)</h2>
  <pre id="debug">Loading…</pre>

  <script>
    const FEED_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgCCTMaaIprAYPWN3APttlxVJHcYz4o-M3qcb-RQ88q56ELcDlRoV4vgt8l2M-biHmgKN4sNOL76BNvyog5YsfljgYLgbWT3wbEvhs1bU_7f19d1zuineuM1_unjItIkcoVUOI_h8ODS1vCB6uXFqe8ovymJkH41E25qNUL1FiCNRzMDyhfjXGan163id1weWelMYepjB76lJBgXK8S04l7i5FWzWzlG-qKpduDNUjnllbWchrQNBPu_LdSC07QIOPfAFc28BplEv5I7JOM5bCHsnA7Cg&lib=M8lagRe57C8vsSC3fjb8eS4jldFBKTi0l";

    const DONE_SIGNALS = ["Submission_Snapshot","Final","Report","Deck","Slides","Presentation"].map(s=>s.toLowerCase());

    function fmt(iso){
      if(!iso) return "—";
      try { return new Date(iso).toLocaleString(); } catch { return iso; }
    }

    function estimate(folder){
      const files = (folder.files || []);
      const names = files.map(f => (f.name||"").toLowerCase());
      const hasSignal = DONE_SIGNALS.some(sig => names.some(n => n.includes(sig)));
      if (hasSignal) return 100;
      if (files.length > 0) return 40;
      return 10;
    }

    async function main(){
      document.getElementById("refresh").textContent = new Date().toLocaleString();

      const res = await fetch(FEED_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("Fetch failed: " + res.status);

      const data = await res.json();
      document.getElementById("debug").textContent = JSON.stringify(data, null, 2);

      document.getElementById("generatedAt").textContent = fmt(data.generatedAt);
      document.getElementById("rootLink").href = data.root?.url || "#";

      const folders = data.folders || [];
      let sum=0;
      for(const f of folders) sum += estimate(f);
      const overall = folders.length ? Math.round(sum / folders.length) : 0;

      document.getElementById("overallPct").textContent = overall + "%";
      document.getElementById("overallBar").style.width = overall + "%";

      const container = document.getElementById("folders");
      container.innerHTML = "";

      for(const folder of folders){
        const pct = estimate(folder);
        const div = document.createElement("div");
        div.className = "card";
        const files = (folder.files || []).slice(0,5).map(file =>
          `<div class="muted"><a target="_blank" rel="noopener" href="${file.url}">${file.name}</a> • ${fmt(file.lastUpdated)}</div>`
        ).join("");

        div.innerHTML = `
          <div><b><a target="_blank" rel="noopener" href="${folder.url}">${folder.name}</a></b></div>
          <div class="muted">Last updated: ${fmt(folder.lastUpdated)} • Progress: <b>${pct}%</b></div>
          <div class="bar"><span style="width:${pct}%"></span></div>
          <div style="margin-top:10px;">${files || `<div class="muted">No files listed yet.</div>`}</div>
        `;
        container.appendChild(div);
      }
    }

    main().catch(err => {
      document.getElementById("debug").textContent = String(err);
    });
  </script>
</body>
</html>
